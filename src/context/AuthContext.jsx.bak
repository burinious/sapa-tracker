import { createContext, useContext, useEffect, useMemo, useState } from "react";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile,
  onAuthStateChanged,
} from "firebase/auth";
import { doc, serverTimestamp, setDoc, getDoc, updateDoc } from "firebase/firestore";
import { auth, db } from "../firebase/firebase";

const AuthContext = createContext(null);
const localKey = (uid) => sapa_profile_;

function getLocalProfile(uid) {
  try { const raw = localStorage.getItem(localKey(uid)); return raw ? JSON.parse(raw) : null; }
  catch { return null; }
}
function setLocalProfile(uid, profile) {
  try { localStorage.setItem(localKey(uid), JSON.stringify(profile)); } catch {}
}

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [loading, setLoading] = useState(true);

  async function tryFirestore(fn) {
    try { return await fn(); }
    catch (err) { console.warn("Firestore unavailable (local-only mode):", err?.message || err); return null; }
  }

  async function signup(email, password, extra = {}) {
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    if (extra?.name) await updateProfile(cred.user, { displayName: extra.name });

    const baseProfile = {
      uid: cred.user.uid,
      email: cred.user.email || email,
      name: extra?.name || cred.user.displayName || "",
      storeName: extra?.storeName || "My Sapa Tracker",
      logoUrl: extra?.logoUrl || "",
      cashAtHand: 0,
      createdAtISO: new Date().toISOString(),
      updatedAtISO: new Date().toISOString(),
      cloudEnabled: false,
    };

    const userRef = doc(db, "users", cred.user.uid);
    const ok = await tryFirestore(() =>
      setDoc(userRef, {
        uid: baseProfile.uid,
        email: baseProfile.email,
        name: baseProfile.name,
        storeName: baseProfile.storeName,
        logoUrl: baseProfile.logoUrl,
        cashAtHand: baseProfile.cashAtHand,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
    );

    if (ok === null) { setLocalProfile(cred.user.uid, baseProfile); setProfile(baseProfile); }
    return cred.user;
  }

  async function login(email, password) {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    return cred.user;
  }

  async function logout() { await signOut(auth); }

  async function updateUserProfile(updates = {}) {
    if (!auth.currentUser) throw new Error("Not authenticated");
    if (typeof updates.name === "string") await updateProfile(auth.currentUser, { displayName: updates.name });

    const uid = auth.currentUser.uid;
    const userRef = doc(db, "users", uid);

    const ok = await tryFirestore(() => updateDoc(userRef, { ...updates, updatedAt: serverTimestamp() }));
    if (ok !== null) {
      const snap = await tryFirestore(() => getDoc(userRef));
      if (snap && snap.exists()) { setProfile({ ...snap.data(), cloudEnabled: true }); return; }
    }

    const current = getLocalProfile(uid) || {
      uid,
      email: auth.currentUser.email || "",
      name: auth.currentUser.displayName || "",
      storeName: "My Sapa Tracker",
      logoUrl: "",
      cashAtHand: 0,
      createdAtISO: new Date().toISOString(),
      updatedAtISO: new Date().toISOString(),
      cloudEnabled: false,
    };
    const next = { ...current, ...updates, updatedAtISO: new Date().toISOString(), cloudEnabled: false };
    setLocalProfile(uid, next);
    setProfile(next);
  }

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      setUser(u);
      try {
        if (u) {
          const uid = u.uid;
          const userRef = doc(db, "users", uid);
          const snap = await tryFirestore(() => getDoc(userRef));

          if (snap && snap.exists()) {
            setProfile({ ...snap.data(), cloudEnabled: true });
          } else {
            const local = getLocalProfile(uid);
            if (local) setProfile(local);
            else {
              const minimal = {
                uid, email: u.email || "", name: u.displayName || "",
                storeName: "My Sapa Tracker", logoUrl: "", cashAtHand: 0,
                createdAtISO: new Date().toISOString(), updatedAtISO: new Date().toISOString(),
                cloudEnabled: false,
              };
              setLocalProfile(uid, minimal);
              setProfile(minimal);
            }

            await tryFirestore(() => setDoc(userRef, {
              uid, email: u.email || "", name: u.displayName || "",
              storeName: "My Sapa Tracker", logoUrl: "", cashAtHand: 0,
              createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
            }));
          }
        } else setProfile(null);
      } finally { setLoading(false); }
    });
    return () => unsub();
  }, []);

  const value = useMemo(
    () => ({ user, profile, loading, signup, login, logout, updateUserProfile, setProfile }),
    [user, profile, loading]
  );

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error("useAuth must be used inside AuthProvider");
  return ctx;
}
